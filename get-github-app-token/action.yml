name: 'Get GitHub App Installation Token'
description: 'Generate JWT and get installation access token in one step'
inputs:
  app-id:
    description: 'GitHub App ID'
    required: true
  private-key:
    description: 'GitHub App private key (PEM format)'
    required: true
  installation-id:
    description: 'GitHub App installation ID'
    required: true
outputs:
  token:
    description: 'Installation access token'
  expires-at:
    description: 'Token expiration timestamp'
runs:
  using: 'composite'
  steps:
    - name: Generate JWT and get installation token
      shell: bash
      run: |
        set -e
        
        # Install required tools
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        if ! command -v openssl &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y openssl
        fi
        if ! command -v curl &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y curl
        fi
        
        APP_ID="${{ inputs.app-id }}"
        PRIVATE_KEY="${{ inputs.private-key }}"
        INSTALLATION_ID="${{ inputs.installation-id }}"
        
        # Generate JWT token
        NOW=$(date +%s)
        EXP=$(($NOW + 600))  # 10 minutes from now
        
        HEADER='{"alg":"RS256","typ":"JWT"}'
        PAYLOAD=$(jq -n \
          --argjson iat $NOW \
          --argjson exp $EXP \
          --argjson iss $APP_ID \
          '{iat: $iat, exp: $exp, iss: ($iss | tonumber)}')
        
        # Base64 encode (URL-safe, no padding)
        HEADER_B64=$(echo -n "$HEADER" | base64 | tr -d '\n=' | tr '/+' '_-')
        PAYLOAD_B64=$(echo -n "$PAYLOAD" | base64 | tr -d '\n=' | tr '/+' '_-')
        
        # Create signature using the private key
        SIGNATURE_INPUT="${HEADER_B64}.${PAYLOAD_B64}"
        
        # Write private key to temp file for openssl
        TEMP_KEY=$(mktemp)
        echo "$PRIVATE_KEY" > "$TEMP_KEY"
        chmod 600 "$TEMP_KEY"
        
        # Sign and encode
        SIGNATURE=$(echo -n "$SIGNATURE_INPUT" | openssl dgst -sha256 -sign "$TEMP_KEY" -binary | base64 | tr -d '\n=' | tr '/+' '_-')
        
        # Clean up
        rm -f "$TEMP_KEY"
        
        JWT_TOKEN="${SIGNATURE_INPUT}.${SIGNATURE}"
        
        # Get installation access token using JWT
        API_URL="https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens"
        
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer $JWT_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "$API_URL")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" != "201" ]; then
          echo "::error::Failed to generate installation token (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi
        
        # Parse JSON response
        TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.token // empty')
        EXPIRES_AT=$(echo "$RESPONSE_BODY" | jq -r '.expires_at // empty')
        
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "::error::Token not found in response"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi
        
        # Save to outputs
        {
          echo "token<<EOF"
          echo "$TOKEN"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"
        
        if [ -n "$EXPIRES_AT" ] && [ "$EXPIRES_AT" != "null" ]; then
          echo "expires-at=$EXPIRES_AT" >> "$GITHUB_OUTPUT"
        fi
        
        echo "::add-mask::$TOKEN"
        echo "âœ… Successfully generated installation access token"
        if [ -n "$EXPIRES_AT" ] && [ "$EXPIRES_AT" != "null" ]; then
          echo "Token expires at: $EXPIRES_AT"
        fi

